<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="SafeBar Manager Settings - Configure your bar management system">
    <title>Settings - SafeBar Manager</title>
    <link rel="icon" href="logo.png" type="image/png">
    <link rel="stylesheet" href="css/settings.css">
</head>

<body>
    <div class="container">
        <header>
            <img src="logo.png" alt="Logo" id="headerLogo">
            <h1 id="headerTitle">Settings</h1>
            <a href="index.html" class="back-link">‚Üê Back to Dashboard</a>
        </header>

        <div class="tabs">
            <button class="tab-btn active" data-tab="business">üè¢ Business Info</button>
            <button class="tab-btn" data-tab="inventory">üì¶ Inventory</button>
            <button class="tab-btn" data-tab="staff">üë• Staff</button>
            <button class="tab-btn" data-tab="email">üìß Email Settings</button>
            <button class="tab-btn" data-tab="gemini">üß† Gemini AI</button>
        </div>

        <div id="statusMessage" class="status-message"></div>

        <!-- Business Info Tab -->
        <div id="business" class="tab-content active">
            <h2>Business Information</h2>
            <p class="info-text">Customize your bar's branding. These values appear on reports and receipts.</p>
            <div class="section-divider"></div>

            <div class="form-row">
                <div class="form-group">
                    <label for="businessName">Business Name</label>
                    <input type="text" id="businessName" placeholder="Your Bar Name">
                </div>
                <div class="form-group">
                    <label for="currency">Currency Code</label>
                    <input type="text" id="currency" placeholder="UGX">
                </div>
            </div>

            <div class="form-group">
                <label for="reportFooter">Report Footer Text</label>
                <input type="text" id="reportFooter" placeholder="Thank you for your business!">
            </div>

            <button class="btn btn-primary" onclick="saveBusinessSettings()">üíæ Save Business Settings</button>
        </div>

        <!-- Inventory Tab -->
        <div id="inventory" class="tab-content">
            <h2>Manage Inventory</h2>
            <p class="info-text">Add, edit, or remove drinks from your inventory. Changes take effect immediately.</p>
            <div class="section-divider"></div>

            <div class="add-form">
                <input type="hidden" id="editItemId">
                <input type="text" id="newItemName" placeholder="Item Name (e.g., Tusker Lager)">
                <select id="newItemCategory" aria-label="New Item Category">
                    <option value="Beers">Beers</option>
                    <option value="Sodas">Sodas</option>
                    <option value="Spirits">Spirits</option>
                    <option value="Wines">Wines</option>
                    <option value="Cocktails">Cocktails</option>
                    <option value="Other">Other</option>
                </select>
                <input type="number" id="newItemPrice" placeholder="Price">
                <button class="btn btn-primary" id="saveItemBtn" onclick="saveItem()">+ Add</button>
                <button class="btn btn-secondary hidden" onclick="cancelEdit()" id="cancelEditBtn">Cancel</button>
            </div>

            <div class="mb-20">
                <button class="btn btn-sm btn-secondary" onclick="bulkUpdateBeers()">üîß Set All Beers to 7,000</button>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Price</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="inventoryTable">
                    <!-- Populated via JS -->
                </tbody>
            </table>
        </div>

        <!-- Staff Tab -->
        <div id="staff" class="tab-content">
            <h2>Manage Staff</h2>
            <p class="info-text">Add or remove barstaff members. These names appear in the barstaff dropdown.</p>
            <div class="section-divider"></div>

            <div class="add-form">
                <input type="text" id="newStaffName" placeholder="Staff Name">
                <select id="newStaffRole" aria-label="New Staff Role">
                    <option value="Barstaff">Barstaff</option>
                    <option value="Manager">Manager</option>
                    <option value="Supervisor">Supervisor</option>
                </select>
                <input type="text" id="newStaffPin" placeholder="PIN (4 digits)" maxlength="4" class="flex-1 min-w-100">
                <button class="btn btn-primary" onclick="addStaff()">+ Add Staff</button>
            </div>

            <!-- Change PIN Modal -->
            <div id="pinModal" class="modal hidden">
                <div class="modal-content">
                    <h3 class="modal-title">Change PIN</h3>
                    <p id="pinModalUser" class="modal-text"></p>
                    <input type="hidden" id="pinModalUserId">
                    <input type="text" id="pinModalNewPin" placeholder="New PIN (4 digits)" maxlength="4"
                        class="modal-input">
                    <div class="modal-actions">
                        <button class="btn btn-secondary" onclick="closePinModal()">Cancel</button>
                        <button class="btn btn-primary" onclick="saveNewPin()">Save</button>
                    </div>
                </div>
            </div>

            <table>
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Role</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="staffTable">
                    <!-- Populated via JS -->
                </tbody>
            </table>
        </div>

        <!-- Email Tab -->
        <div id="email" class="tab-content">
            <h2>Email Configuration</h2>
            <p class="info-text">Configure SMTP settings for sending daily reports via email.</p>
            <div class="section-divider"></div>

            <div class="form-row">
                <div class="form-group">
                    <label for="ownerEmail">Owner Email (Receive Reports)</label>
                    <input type="email" id="ownerEmail" placeholder="owner@example.com">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="smtpHost">SMTP Host</label>
                    <input type="text" id="smtpHost" placeholder="smtp.gmail.com">
                </div>
                <div class="form-group">
                    <label for="smtpPort">SMTP Port</label>
                    <input type="number" id="smtpPort" placeholder="587">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="smtpUser">SMTP Username</label>
                    <input type="text" id="smtpUser" placeholder="your-email@gmail.com">
                </div>
                <div class="form-group">
                    <label for="smtpPass">SMTP Password / App Password</label>
                    <input type="password" id="smtpPass" placeholder="App-specific password">
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveEmailSettings()">üíæ Save Email Settings</button>
            <button class="btn btn-secondary ml-10" onclick="testEmail()">üì¨ Send Test
                Email</button>
        </div>

        <!-- Gemini Tab -->
        <div id="gemini" class="tab-content">
            <h2>Gemini AI Insights</h2>
            <p class="info-text">Analyze your sales data and get actionable insights using Google Gemini.</p>
            <div class="section-divider"></div>

            <div class="form-row">
                <div class="form-group">
                    <label for="geminiKey">Gemini API Key</label>
                    <input type="password" id="geminiKey" placeholder="Enter API Key">
                </div>
            </div>
            <button class="btn btn-primary" onclick="saveGeminiKey()">üíæ Save Key</button>

            <div class="section-divider"></div>
            <h3>Ask Gemini</h3>
            <textarea id="geminiPrompt" class="gemini-textarea"
                placeholder="Ask about your sales performance..."></textarea>
            <button class="btn btn-secondary" onclick="askGemini()">‚ú® Analyze</button>

            <div id="geminiResult" class="gemini-result">
                <em>Insights will appear here...</em>
            </div>
        </div>
    </div>

    <script src="js/supabase-adapter.js"></script>
    <script>
        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });

        function showStatus(message, type = 'success') {
            const el = document.getElementById('statusMessage');
            el.textContent = message;
            el.className = 'status-message ' + type;
            setTimeout(() => { el.className = 'status-message'; }, 3000);
        }

        // ========== LOAD DATA ON START ==========
        async function checkAccess() {
            const user = await window.api.getCurrentUser();
            if (!user) return; // Main will handle redirect usually, but safety check

            if (user.role === 'Barstaff') {
                alert('Access Denied: Managers and Supervisors only.');
                window.location.href = 'index.html';
                return;
            }

            if (user.role === 'Supervisor') {
                // Hide tabs
                ['business', 'inventory', 'email', 'gemini'].forEach(tab => {
                    const btn = document.querySelector(`button[data-tab="${tab}"]`);
                    if (btn) btn.style.display = 'none';
                });

                // Click Staff tab
                const staffBtn = document.querySelector('button[data-tab="staff"]');
                if (staffBtn) staffBtn.click();
            }
        }

        async function loadAllData() {
            await checkAccess();
            await loadSettings();
            await loadInventory();
            await loadStaff();
        }

        async function loadSettings() {
            const settings = await window.api.getAllSettings();
            document.getElementById('businessName').value = settings.business_name || '';
            document.getElementById('currency').value = settings.currency || 'UGX';
            document.getElementById('reportFooter').value = settings.report_footer || '';
            document.getElementById('ownerEmail').value = settings.owner_email || '';
            document.getElementById('smtpHost').value = settings.smtp_host || '';
            document.getElementById('smtpPort').value = settings.smtp_port || '587';
            document.getElementById('smtpUser').value = settings.smtp_user || '';
            document.getElementById('smtpPass').value = settings.smtp_pass || '';
            const geminiKey = settings.gemini_key || '';
            const keyInput = document.getElementById('geminiKey');
            if (keyInput) keyInput.value = geminiKey;
            showStatus('‚úÖ Email settings saved!');
        }

        async function saveGeminiKey() {
            const key = document.getElementById('geminiKey').value;
            await window.api.saveSettings({ gemini_key: key });
            showStatus('‚úÖ API Key saved!');
        }

        async function askGemini() {
            const prompt = document.getElementById('geminiPrompt').value;
            if (!prompt) return;

            const resultDiv = document.getElementById('geminiResult');
            resultDiv.innerHTML = '<em>Thinking... (Integration Placeholder)</em>';

            // Here we would call window.api.askGemini(prompt)
            // For now, simple response
            setTimeout(() => {
                resultDiv.innerHTML = '<strong>Gemini:</strong> This feature is ready to be connected to the Google Gemini API once you provide a valid key and backend implementation.';
            }, 1000);
        }

        async function loadInventory() {
            const items = await window.api.getInventory();
            const tbody = document.getElementById('inventoryTable');
            tbody.innerHTML = items.map(item => `
        <tr data-id="${item.id}">
          <td>${item.name}</td>
          <td>${item.category}</td>
          <td>${item.price.toLocaleString()}</td>
          <td>
            <button class="btn btn-secondary btn-sm" onclick="editItem(${item.id}, '${item.name.replace(/'/g, "\\'")}', '${item.category}', ${item.price})">Edit</button>
            <button class="btn btn-danger btn-sm" onclick="deleteItem(${item.id})">Delete</button>
          </td>
        </tr>
      `).join('');
        }

        async function loadStaff() {
            const staff = await window.api.getStaff();
            const tbody = document.getElementById('staffTable');
            tbody.innerHTML = staff.map(s => `
        <tr data-id="${s.id}">
          <td>${s.name}</td>
          <td>${s.role}</td>
          <td>
            <button class="btn btn-secondary btn-sm" onclick="openPinModal(${s.id}, '${s.name}')">PIN</button>
            <button class="btn btn-danger btn-sm" onclick="deleteStaffMember(${s.id})">Delete</button>
          </td>
        </tr>
      `).join('');
        }

        // ========== PIN MODAL ==========
        function openPinModal(id, name) {
            document.getElementById('pinModalUserId').value = id;
            document.getElementById('pinModalUser').textContent = `For staff: ${name}`;
            document.getElementById('pinModalNewPin').value = '';
            document.getElementById('pinModal').classList.remove('hidden');
            document.getElementById('pinModal').style.display = 'flex';
            document.getElementById('pinModalNewPin').focus();
        }

        function closePinModal() {
            document.getElementById('pinModal').classList.add('hidden');
            document.getElementById('pinModal').style.display = 'none';
        }

        async function saveNewPin() {
            const id = document.getElementById('pinModalUserId').value;
            const pin = document.getElementById('pinModalNewPin').value;

            if (!pin || pin.length !== 4 || isNaN(pin)) {
                alert('PIN must be 4 digits');
                return;
            }

            const result = await window.api.updateStaffPin({ id, pin });
            if (result.success) {
                closePinModal();
                showStatus('‚úÖ PIN updated successfully!');
            } else {
                alert('Error: ' + result.error);
            }
        }

        // ========== SAVE FUNCTIONS ==========
        async function saveBusinessSettings() {
            await window.api.saveSettings({
                business_name: document.getElementById('businessName').value,
                currency: document.getElementById('currency').value,
                currency_symbol: document.getElementById('currency').value,
                report_footer: document.getElementById('reportFooter').value,
            });
            showStatus('‚úÖ Business settings saved!');
        }

        async function saveEmailSettings() {
            await window.api.saveSettings({
                owner_email: document.getElementById('ownerEmail').value,
                smtp_host: document.getElementById('smtpHost').value,
                smtp_port: document.getElementById('smtpPort').value,
                smtp_user: document.getElementById('smtpUser').value,
                smtp_pass: document.getElementById('smtpPass').value,
            });
            showStatus('‚úÖ Email settings saved!');
        }

        // ========== INVENTORY CRUD ==========
        async function saveItem() {
            const id = document.getElementById('editItemId').value;
            const name = document.getElementById('newItemName').value.trim();
            const category = document.getElementById('newItemCategory').value;
            const price = parseInt(document.getElementById('newItemPrice').value) || 0;

            if (!name || name.length < 2) {
                showStatus('‚ùå Item name must be at least 2 characters', 'error');
                return;
            }
            if (price < 0) {
                showStatus('‚ùå Price cannot be negative', 'error');
                return;
            }

            let result;
            if (id) {
                // Update
                result = await window.api.updateInventoryItem({ id, name, category, price });
                if (result.success) showStatus('‚úÖ Item updated!');
            } else {
                // Add
                result = await window.api.addInventoryItem({ name, category, price });
                if (result.success) showStatus('‚úÖ Item added!');
            }

            if (result.success) {
                cancelEdit();
                await loadInventory();
            } else {
                showStatus('‚ùå ' + result.error, 'error');
            }
        }

        function editItem(id, name, category, price) {
            // Unescape quotes if needed or handle simple strings
            document.getElementById('editItemId').value = id;
            document.getElementById('newItemName').value = name;
            document.getElementById('newItemCategory').value = category;
            document.getElementById('newItemPrice').value = price;

            document.getElementById('saveItemBtn').textContent = 'üíæ Update';
            document.getElementById('cancelEditBtn').classList.remove('hidden');

            // Scroll to form
            document.querySelector('.add-form').scrollIntoView({ behavior: 'smooth' });
        }

        function cancelEdit() {
            document.getElementById('editItemId').value = '';
            document.getElementById('newItemName').value = '';
            document.getElementById('newItemPrice').value = '';
            document.getElementById('saveItemBtn').textContent = '+ Add';
            document.getElementById('cancelEditBtn').classList.add('hidden');
        }

        async function bulkUpdateBeers() {
            if (confirm('Are you certain? This will set all "Beers" to 7,000.')) {
                const items = await window.api.getInventoryByCategory();
                const beers = items['Beers'] || [];
                let count = 0;
                for (const beer of beers) {
                    await window.api.updateInventoryItem({
                        id: beer.id,
                        name: beer.name,
                        category: 'Beers',
                        price: 7000
                    });
                    count++;
                }
                await loadInventory();
                showStatus(`‚úÖ Updated ${count} beers to 7,000!`);
            }
        }

        async function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                await window.api.deleteInventoryItem(id);
                await loadInventory();
                showStatus('‚úÖ Item deleted');
            }
        }

        // ========== STAFF CRUD ==========
        async function addStaff() {
            const name = document.getElementById('newStaffName').value.trim();
            const role = document.getElementById('newStaffRole').value;
            const pin = document.getElementById('newStaffPin').value.trim();

            if (!name) {
                showStatus('‚ùå Please enter a staff name', 'error');
                return;
            }
            if (!pin || pin.length !== 4) {
                showStatus('‚ùå PIN must be 4 digits', 'error');
                return;
            }

            const result = await window.api.addStaff({ name, role, pin });
            if (result.success) {
                document.getElementById('newStaffName').value = '';
                await loadStaff();
                showStatus('‚úÖ Staff member added!');
            } else {
                showStatus('‚ùå ' + result.error, 'error');
            }
        }

        async function deleteStaffMember(id) {
            if (confirm('Are you sure you want to remove this staff member?')) {
                await window.api.deleteStaff(id);
                await loadStaff();
                showStatus('‚úÖ Staff member removed');
            }
        }

        function testEmail() {
            showStatus('üìß Test email feature coming soon...', 'success');
        }

        // Initialize
        loadAllData();
    </script>
</body>

</html>